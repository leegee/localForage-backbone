!function(a,b){if("function"==typeof define&&define.amd)define(["localforage","backbone","underscore"],b);else if("undefined"!=typeof module&&module.exports){var c=require("localforage"),d=require("backbone"),e=require("underscore");module.exports=b(c,d,e)}else b(a.localforage,a.Backbone,a._)}(this,function(a,b,c){function d(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function e(){return d()+d()+"-"+d()+"-"+d()+"-"+d()+"-"+d()+d()+d()}return b.localforage={localforageInstance:a,sync:function(a){var c=this,d=function(d,f,g){switch(this instanceof b.Collection?f.sync.localforageKey=a:(f.id||(f[this.idAttribute]=f.attributes[this.idAttribute]=e()),f.sync.localforageKey=a+"/"+f.id),d){case"read":return f.id?c.find(f,g):c.findAll(f,g);case"create":return c.create(f,g);case"update":return c.update(f,g);case"delete":return c.destroy(f,g)}};return d._localforageNamespace=a,d},save:function(b,d){a.setItem(b.sync.localforageKey,b.toJSON(),function(e,f){if(b.collection){var g=b.collection,h=g.map(function(a){return g.model.prototype.sync._localforageNamespace+"/"+a.id});b.collection.sync.localforageKey||(b.collection.sync.localforageKey=b.collection.sync._localforageNamespace),d=d?c.partial(d,e,f):void 0,a.setItem(b.collection.sync.localforageKey,h,d)}else d&&d(f)})},create:function(a,b){return this.update(a,b)},update:function(a,b){this.save(a,function(a){b.success&&b.success(a)})},find:function(b,d){a.getItem(b.sync.localforageKey,function(a,b){a||c.isEmpty(b)?d.error&&d.error():d.success&&d.success(b)})},findAll:function(b,d){a.getItem(b.sync.localforageKey,function(b,e){if(!b&&e&&e.length){var f=function(){d.success&&d.success(e)};f=c.after(e.length,f);for(var g=function(a,b,c){e[a]=c,f()},h=0;h<e.length;++h)a.getItem(e[h],c.partial(g,h))}else e=[],d.success&&d.success(e)})},destroy:function(b,c){a.removeItem(b.sync.localforageKey,function(){var a=b.toJSON();c.success&&c.success(a)})}},b.localforage});